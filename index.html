<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload JSON → Lấy cột cần → Xuất bảng/CSV</title>

  <!-- Tabulator (table + filter + pagination + download CSV) -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    h2 { margin: 0 0 12px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { padding: 6px; }
    button { padding: 8px 12px; cursor: pointer; }
    .badge { display:inline-block; padding:2px 10px; border:1px solid #ddd; border-radius:999px; }
    .note { color:#555; font-size: 14px; margin-top: 10px; line-height: 1.45; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    pre {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 0;
      font-size: 13px;
      color: #333;
    }
    #table { margin-top: 14px; }
    .muted { color:#666; font-size: 13px; }
    code { background:#f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Upload JSON → Lấy cột cần → Xuất bảng/CSV</h2>

  <div class="row">
    <input id="file" type="file" accept=".json,application/json" multiple />
    <button id="downloadCsv" disabled>Tải CSV</button>
    <button id="clear" disabled>Xóa bảng</button>
    <span id="stat" class="badge">0 rows</span>
  </div>

  <div class="note">
    <div><b>Cách dùng:</b> Chọn 1 hoặc nhiều file JSON. Tool sẽ gom dữ liệu và chỉ lấy đúng các cột đã cấu hình.</div>
    <div class="muted">
      Path lấy dữ liệu dùng dấu chấm, ví dụ:
      <code>Device.Template.GlobalConfiguration.APIBlackout.LocalFilename</code>
      hoặc có mảng:
      <code>Device.Template.Tracks.AudioTracks[0].Language</code>
    </div>
  </div>

  <div class="grid">
    <pre id="keys">Keys phát hiện sẽ hiện ở đây sau khi bạn upload (để bạn biết key thật trong JSON và map path cho đúng).</pre>
  </div>

  <div id="table"></div>

  <script>
    // =========================
    // 1) CẤU HÌNH CỘT (CHỈ SỬA Ở ĐÂY)
    // =========================
    // title: tên cột hiển thị
    // path: đường dẫn key trong JSON (dạng dấu chấm; hỗ trợ [0] cho mảng)
    const COLUMNS_WANTED = [
      // Bạn yêu cầu: lấy "Chuongtrinh_Start.png" từ APIBlackout.LocalFilename
      { title: "start all", path: "Device.Template.GlobalConfiguration.APIBlackout.LocalFilename" },

      // Một vài cột gợi ý hay dùng (bạn có thể xóa/đổi/thêm)
      { title: "template name", path: "Device.Template.Name" },
      { title: "format type", path: "Device.Template.FormatConfigurations.Type" },

      // Ví dụ audio tracks (nếu có)
      { title: "audio_1_lang", path: "Device.Template.Tracks.AudioTracks[0].Language" },
      { title: "audio_2_lang", path: "Device.Template.Tracks.AudioTracks[1].Language" },

      // Ví dụ video pid / encoder (tùy file bạn)
      { title: "video_pid", path: "Device.Template.Tracks.VideoTracks[0].Pid" },
    ];

    // Thêm cột file name để biết dòng này đến từ file nào
    const ADD_FILENAME_COLUMN = true;

    // Pagination size
    const PAGE_SIZE = 30;

    // =========================
    // 2) LOGIC (KHÔNG CẦN SỬA)
    // =========================
    const fileInput = document.getElementById("file");
    const downloadBtn = document.getElementById("downloadCsv");
    const clearBtn = document.getElementById("clear");
    const statEl = document.getElementById("stat");
    const keysBox = document.getElementById("keys");

    let table;

    function isObject(v) {
      return v && typeof v === "object" && !Array.isArray(v);
    }

    // Unwrap JSON về dạng rows (mảng object)
    function toRows(json) {
      // 1) Nếu là mảng -> ok
      if (Array.isArray(json)) return json;

      // 2) Nếu là object -> thử "unwrap" mảng phổ biến
      if (isObject(json)) {
        const candidates = ["data", "items", "results", "rows", "list"];
        for (const k of candidates) {
          if (Array.isArray(json[k])) return json[k];
        }

        // 3) Nếu object chỉ có 1 key và value là array -> unwrap luôn
        const keys = Object.keys(json);
        if (keys.length === 1 && Array.isArray(json[keys[0]])) return json[keys[0]];

        // 4) Không unwrap được -> coi như 1 row
        return [json];
      }

      throw new Error("JSON không phải object hoặc array.");
    }

    // Hỗ trợ path có index kiểu items[0].name
    function getByPath(obj, path) {
      if (!path) return undefined;
      const parts = path
        .replace(/\[(\d+)\]/g, ".$1") // [0] -> .0
        .split(".")
        .filter(Boolean);

      let cur = obj;
      for (const p of parts) {
        if (cur == null) return undefined;
        cur = cur[p];
      }
      return cur;
    }

    function normalizeValue(v) {
      if (v == null) return "";
      if (typeof v === "string" || typeof v === "number" || typeof v === "boolean") return v;
      try { return JSON.stringify(v); } catch { return String(v); }
    }

    function projectRow(row, fileName) {
      const out = {};
      if (ADD_FILENAME_COLUMN) out["_file"] = fileName;

      for (const c of COLUMNS_WANTED) {
        out[c.title] = normalizeValue(getByPath(row, c.path));
      }
      return out;
    }

    function buildColumns() {
      const cols = [];
      if (ADD_FILENAME_COLUMN) cols.push({ title: "file", field: "_file", headerFilter: "input" });

      for (const c of COLUMNS_WANTED) {
        cols.push({ title: c.title, field: c.title, headerFilter: "input" });
      }
      return cols;
    }

    function showKeysPreview(firstRow, fileName) {
      if (!firstRow || typeof firstRow !== "object") {
        keysBox.textContent = "Không tìm thấy object hợp lệ để hiển thị keys.";
        return;
      }

      const topKeys = Object.keys(firstRow);
      keysBox.textContent =
        `Keys phát hiện (dòng đầu tiên của file: ${fileName})\n` +
        topKeys.join(", ") +
        `\n\nGợi ý:\n- Nếu bạn cần key lồng nhau, hãy viết path kiểu A.B.C\n- Nếu là mảng, dùng [0], [1]...\nVí dụ: Device.Template.Tracks.AudioTracks[0].Language`;
    }

    async function readAllFiles(files) {
      const all = [];
      keysBox.textContent = "Đang đọc file...";

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        const text = await f.text();
        const json = JSON.parse(text);

        const rows = toRows(json);

        // Preview keys: lấy row đầu tiên của file đầu tiên
        if (i === 0 && rows.length > 0) {
          showKeysPreview(rows[0], f.name);
        }

        for (const r of rows) {
          all.push(projectRow(r, f.name));
        }
      }
      return all;
    }

    function setUiState({ loading, rowsCount }) {
      if (loading) {
        statEl.textContent = "loading...";
        downloadBtn.disabled = true;
        clearBtn.disabled = true;
        return;
      }
      statEl.textContent = `${rowsCount} rows`;
      downloadBtn.disabled = rowsCount === 0;
      clearBtn.disabled = rowsCount === 0;
    }

    fileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      try {
        setUiState({ loading: true, rowsCount: 0 });

        const data = await readAllFiles(files);
        const columns = buildColumns();

        if (table) table.destroy();

        table = new Tabulator("#table", {
          data,
          columns,
          layout: "fitDataStretch",
          pagination: true,
          paginationSize: PAGE_SIZE,
          movableColumns: true,
          height: "70vh",
        });

        setUiState({ loading: false, rowsCount: data.length });

      } catch (err) {
        alert("Lỗi đọc JSON: " + (err?.message || err));
        keysBox.textContent = "Lỗi: không đọc được JSON hoặc JSON không đúng định dạng.";
        if (table) { table.destroy(); table = null; }
        setUiState({ loading: false, rowsCount: 0 });
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!table) return;
      table.download("csv", "extracted.csv");
    });

    clearBtn.addEventListener("click", () => {
      if (table) { table.destroy(); table = null; }
      keysBox.textContent = "Keys phát hiện sẽ hiện ở đây sau khi bạn upload (để bạn biết key thật trong JSON và map path cho đúng).";
      statEl.textContent = "0 rows";
      downloadBtn.disabled = true;
      clearBtn.disabled = true;
      fileInput.value = "";
    });
  </script>
</body>
</html>
