<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JSON Profiles Audit → Table/CSV</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    h2 { margin: 0 0 12px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { padding: 6px; }
    button { padding: 8px 12px; cursor: pointer; }
    .badge { display:inline-block; padding:2px 10px; border:1px solid #ddd; border-radius:999px; }
    .note { color:#555; font-size: 14px; margin-top: 10px; line-height: 1.45; }
    #table { margin-top: 14px; }
    pre {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 10px 0 0 0;
      font-size: 13px;
      color: #333;
    }
    code { background:#f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Upload JSON → Bảng Profiles (bitrate/fps/size/logo/output)</h2>

  <div class="row">
    <input id="file" type="file" accept=".json,application/json" multiple />
    <button id="downloadCsv" disabled>Tải CSV</button>
    <button id="clear" disabled>Xóa bảng</button>
    <span id="stat" class="badge">0 rows</span>
  </div>

  <div class="note">
    Tool sẽ tự đọc theo cấu trúc kiểu file của bạn:
    <code>Device.Template.FormatConfigurations[0].TSMuxer.Profiles</code>,
    <code>Device.Template.Tracks.VideoTracks[0].Variants</code>,
    <code>Outputs[0][profileIndex].Outputs</code>.
    Nếu file không đúng format này, một số cột sẽ trống.
  </div>

  <pre id="debug">Debug sẽ hiện ở đây (nếu file thiếu key hoặc cấu trúc khác).</pre>

  <div id="table"></div>

  <script>
    const fileInput = document.getElementById("file");
    const downloadBtn = document.getElementById("downloadCsv");
    const clearBtn = document.getElementById("clear");
    const statEl = document.getElementById("stat");
    const debugEl = document.getElementById("debug");

    let table;

    function isObject(v) {
      return v && typeof v === "object" && !Array.isArray(v);
    }

    function safeGet(obj, pathArr) {
      let cur = obj;
      for (const k of pathArr) {
        if (cur == null) return undefined;
        cur = cur[k];
      }
      return cur;
    }

    function toJobs(json) {
      // File của bạn top-level là array chứa job objects.
      // Nhưng để robust: nếu là object -> bọc lại.
      if (Array.isArray(json)) return json;
      if (isObject(json)) return [json];
      return [];
    }

    function formatMbps(bps) {
      if (bps == null || bps === "") return "";
      const mbps = Number(bps) / 1_000_000;
      // Giữ 1 chữ số thập phân giống bảng bạn
      return Math.round(mbps * 10) / 10;
    }

    function pickGroupLogo(variant) {
      const logos = variant?.LogoInsertions || [];
      const enabled = logos.filter(l => l && l.Enable && l.FileName);

      if (!enabled.length) return "";

      // Ưu tiên "logo nhóm" (khác Fplay_TT_EPL.png)
      for (const l of enabled) {
        if (l.FileName !== "Fplay_TT_EPL.png") return l.FileName;
      }
      return enabled[0].FileName;
    }

    function joinOutputUrls(outputGroup) {
      const outs = outputGroup?.Outputs || [];
      const urls = outs
        .filter(o => o && (o.EnableOutput === undefined || o.EnableOutput === true) && o.Url)
        .map(o => o.Url);
      return urls.join(" | ");
    }

    function buildRowsFromJob(job, fileName) {
      const rows = [];

      const template = job?.Device?.Template;
      const profiles = safeGet(template, ["FormatConfigurations", 0, "TSMuxer", "Profiles"]) || [];
      const variants = safeGet(template, ["Tracks", "VideoTracks", 0, "Variants"]) || [];
      const outputGroups = safeGet(job, ["Outputs", 0]) || []; // list length = number of profiles

      const jobName = job?.Name ?? "";
      const tmplName = template?.Name ?? "";

      for (let i = 0; i < profiles.length; i++) {
        // Profile i -> VariantIdx (thường i, nhưng mình đọc đúng field)
        const variantIdx =
          safeGet(profiles[i], ["TracksMapping", "VideoTrackList", 0, "VariantIdx"]) ?? i;

        const v = variants[variantIdx] || {};
        const bitrate = safeGet(v, ["Encoding", "Bitrate"]);
        const fps = safeGet(v, ["FrameRateParameters", "FrameRate"]);
        const w = safeGet(v, ["FrameSizeParameters", "Width"]);
        const h = safeGet(v, ["FrameSizeParameters", "Height"]);
        const baseRes = safeGet(v, ["FrameSizeParameters", "Resolution"]);
        const gop = safeGet(v, ["Encoding", "GopParameters", "GopSize"]);
        const groupLogo = pickGroupLogo(v);

        const outGroup = outputGroups[i] || {};
        const outUrls = joinOutputUrls(outGroup);

        rows.push({
          file: fileName,
          job_name: jobName,
          template_name: tmplName,
          profile: i,
          bitrate_mbps: formatMbps(bitrate),
          fps: fps !== undefined ? Number(fps) : "",
          size_px: (w && h) ? `${w}x${h}` : "",
          baseRes: baseRes ?? "",
          gop: gop ?? "",
          logo_group: groupLogo,
          output_urls: outUrls,
        });
      }

      return rows;
    }

    function buildColumns() {
      return [
        { title: "file", field: "file", headerFilter: "input" },
        { title: "job_name", field: "job_name", headerFilter: "input" },
        { title: "template_name", field: "template_name", headerFilter: "input" },

        { title: "Profile", field: "profile", headerFilter: "input" },
        { title: "Bitrate (Mbps)", field: "bitrate_mbps", headerFilter: "input" },
        { title: "FPS", field: "fps", headerFilter: "input" },
        { title: "Size (px)", field: "size_px", headerFilter: "input" },
        { title: "BaseRes", field: "baseRes", headerFilter: "input" },
        { title: "GOP", field: "gop", headerFilter: "input" },
        { title: "Logo “nhóm”", field: "logo_group", headerFilter: "input" },
        { title: "Output URL(s)", field: "output_urls", headerFilter: "input" },
      ];
    }

    async function readAllFiles(files) {
      const allRows = [];
      const dbg = [];

      for (const f of files) {
        try {
          const text = await f.text();
          const json = JSON.parse(text);

          const jobs = toJobs(json);
          if (!jobs.length) {
            dbg.push(`- ${f.name}: Không đọc được jobs (JSON không phải array/object).`);
            continue;
          }

          for (const job of jobs) {
            const rows = buildRowsFromJob(job, f.name);
            if (!rows.length) {
              dbg.push(`- ${f.name}: Không thấy Profiles hoặc Variants theo cấu trúc mong đợi.`);
            }
            allRows.push(...rows);
          }
        } catch (e) {
          dbg.push(`- ${f.name}: Lỗi parse JSON: ${e?.message || e}`);
        }
      }

      debugEl.textContent =
        dbg.length
          ? "Debug:\n" + dbg.join("\n")
          : "Debug: OK (không phát hiện lỗi cấu trúc khi đọc file).";

      return allRows;
    }

    function setUi(rowsCount, loading=false) {
      statEl.textContent = loading ? "loading..." : `${rowsCount} rows`;
      downloadBtn.disabled = loading || rowsCount === 0;
      clearBtn.disabled = loading || rowsCount === 0;
    }

    fileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      try {
        setUi(0, true);

        const data = await readAllFiles(files);
        const columns = buildColumns();

        if (table) table.destroy();

        table = new Tabulator("#table", {
          data,
          columns,
          layout: "fitDataStretch",
          pagination: true,
          paginationSize: 30,
          movableColumns: true,
          height: "70vh",
        });

        setUi(data.length, false);
      } catch (err) {
        alert("Lỗi: " + (err?.message || err));
        debugEl.textContent = "Debug: Có lỗi khi xử lý file.";
        if (table) { table.destroy(); table = null; }
        setUi(0, false);
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!table) return;
      table.download("csv", "profiles_audit.csv");
    });

    clearBtn.addEventListener("click", () => {
      if (table) { table.destroy(); table = null; }
      fileInput.value = "";
      debugEl.textContent = "Debug sẽ hiện ở đây (nếu file thiếu key hoặc cấu trúc khác).";
      setUi(0, false);
    });
  </script>
</body>
</html>
